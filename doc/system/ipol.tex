% Instructions to modify this document:
% * Remember to ALWAYS execute "git pull" BEFORE any commit you make!
% * Use the \ToDo{...} command to remark tasks which still need to be done. Add your name in the comment.
% * Use the \input{file.tex} command to split the document into several parts
% * Do not change the current LaTeX coding style to yours. The style and format should be homogeneous along sections.

% To convert .dia diagrams into PDF:
% 1) Create the diagram with dia
% 2) Export it as .eps
% 3) use epstopdf to convert to PDF


\documentclass[a4paper,12pt]{article}

\usepackage[utf8]{inputenc}
\usepackage{amsmath,graphicx}
\usepackage{bm}
\usepackage{amssymb}
\usepackage{algorithm}
\usepackage{algpseudocode}
\usepackage{subfigure}
\usepackage{ifpdf}
\usepackage{url}
\usepackage{color}
\usepackage[hidelinks]{hyperref}
\usepackage{multirow}
\usepackage{datetime}
\usepackage{comment}
\usepackage{float} % To put figures in their exact place with \begin{figure}[H]
\usepackage{longtable}
\usepackage{tabularx}
\usepackage{listings}
\usepackage{xcolor}


\newcolumntype{L}[1]{>{\raggedright\arraybackslash}p{#1}}
\newcolumntype{C}[1]{>{\centering\arraybackslash}p{#1}}
\newcolumntype{R}[1]{>{\raggedleft\arraybackslash}p{#1}}


% Definitions and commands
\def \np{\vskip 0.25 cm}
\def \ap{\vskip 0.15 cm}

% JSON listing (see 
%  http://tex.stackexchange.com/questions/83085/how-to-improve-listings-display 
% -of- json-files)
\colorlet{punct}{red!60!black}
\definecolor{background}{HTML}{EEEEEE}
\definecolor{delim}{RGB}{20,105,176}
\colorlet{numb}{magenta!60!black}

\lstdefinelanguage{json}{
    basicstyle=\footnotesize\ttfamily,
    numbers=left,
    numberstyle=\scriptsize,
    stepnumber=1,
    numbersep=8pt,
    showstringspaces=false,
    breaklines=true,
    frame=lines,
    backgroundcolor=\color{background},
    literate=
     *{0}{{{\color{numb}0}}}{1}
      {1}{{{\color{numb}1}}}{1}
      {2}{{{\color{numb}2}}}{1}
      {3}{{{\color{numb}3}}}{1}
      {4}{{{\color{numb}4}}}{1}
      {5}{{{\color{numb}5}}}{1}
      {6}{{{\color{numb}6}}}{1}
      {7}{{{\color{numb}7}}}{1}
      {8}{{{\color{numb}8}}}{1}
      {9}{{{\color{numb}9}}}{1}
      {:}{{{\color{punct}{:}}}}{1}
      {,}{{{\color{punct}{,}}}}{1}
      {\{}{{{\color{delim}{\{}}}}{1}
      {\}}{{{\color{delim}{\}}}}}{1}
      {[}{{{\color{delim}{[}}}}{1}
      {]}{{{\color{delim}{]}}}}{1},
}

\lstset{language=Bash, basicstyle=\color{gray}}

\newcommand{\ToDo}[1]{\textcolor{magenta}{\textbf{[ToDo]} \textbf{#1}}}
\newcommand{\miguel}[1]{\textcolor{magenta}{\textbf{[Miguel]} \textbf{#1}}}


\begin{document}


\begin{titlepage}

\begin{center}
\vspace*{-1in}

\vspace*{0.6in}
\begin{Large}
\textbf{The IPOL Demo System 2.0 \\Technical documentation} \\
\end{Large}

\vspace*{0.6in}

\small{Compiled on \today\ at \currenttime}

\vspace*{0.6in}
\rule{80mm}{0.1mm}\\
\vspace*{0.1in}
\end{center}

\end{titlepage}

This document contains technical documentation for the IPOL Demo System 2.0. Specifically, the architecture of the service-oriented platform, its modules, and the real-time template generation of demos from their textual description.
\vspace*{0.6in}

\textbf{Software engineers and external consultats, past and present (in alphabetical order):}


Martín Arévalo

José Arrecio

Miguel Colom

Carlos Escobar

Vincent Firmin

Karl Krissian

José Luis Lisani

Alexis Mongin

Nelson Monzón

\vspace*{0.2in}

\textbf{Project direction and team coordination}

Miguel Colom - \url{http://mcolom.info}



%\maketitle
\newpage

\tableofcontents
\newpage
\listoffigures
\newpage

% Introduction
\input{introduction/introduction.tex}

% Project management and development methodology
\input{methodology/methodology.tex}

% The Core module
\input{core/core.tex}

% The Proxy module
\input{proxy/proxy.tex}

% The Blobs module
\input{blobs/blobs.tex}

% The Archive module
\input{archive/archive.tex}

% The Demo Info module
\input{demo_info/demo_info.tex}

% The Demo Dispatcher module
\input{demo_dispatcher/demo_dispatcher.tex}

% The Demo Runner module
\input{demo_runner/demo_runner.tex}

% The Control Terminal 
\input{terminal/terminal.tex}

% System administration
\input{sysadmin/sysadmin.tex}

% General notes
\section{General notes}
In this section we add general comments on the projects, parts which still neeed to be written or coded. In general, information which needs to be documented but has not still found its place in the document. It works as a reminder not to forget.

\begin{itemize}
  \item The magic module. We use PIP, not the python-magic package found in most distributions. \ToDo{Explain why}.
  \item List of packages needed and how to install them.
  \item Description of the general requirements needed for a module to be part of the system (start, ping, and shutdown services ; structure of the general launching script...
\end{itemize}

- List of packages used for installing the system. Packages to be installed with sudo apt-get install:

\begin{itemize}
\item python2.7
\item wget: to download files
\item cmake: to create a multiplatform Makefile easily
\item libtiff5-dev libtiff-tools libjpeg-dev libpng-dev: open and write TIFF, JPEG, PNG files
\item libfftw3-dev: fast DFT operations
\item libgsl0-dev libeigen3-dev liblapack-dev libblas-dev: linear algebra
\item python python3 python-dev python3-dev python-cherrypy3 python-mako python-jsonschema: Python language, Python headers, webserver, web templating, JSON
\item gnuplot gnuplot-nox: to draw figures
\item python-pip: to install python packages
\item python-yaml: for parsing
\item libpq-dev: PostgreSQL headers
\item texlive-full: compilation of the LaTeX documentation
\item libmagic-dev: needed to install python-magic with pip
\item libav-tools: audio/video tools for demos with these data types
\item libgsl2 libgsl-dev libgsl-dbg  libblas-dev libblas3 liblapack-dev liblapack: numerical computations with GSL, BLAS, LAPACK
\item octave octave-general octave-dataframe octave-image octave-linear-algebra octave-splines octave-statistics: Octave and libraries
\end{itemize}

Packages to be installed with pip install:
\begin{itemize}
\item python-magic
\item pypng
\item numpy
\item libtiff
\item pillow
\item simplejson
\item validoot (\url{https://github.com/AstromechZA/validoot/tarball/1.3})
\end{itemize}

- Example of another demo system: \url{http://places.csail.mit.edu/demo.html}

- Integrate Openseedragon, \url{https://openseadragon.github.io/}

- Document the format of the demo package, with desc.jon, images/, extra/, etc

- Most of our modules name the files according to the hash sum of their contents. This file names are OK for internal use, but the users should obtain the files with the proper names. This can be achieved with the ``download" attribute in HTML5. All website interfaces should provide the corresponding human-readable name. For example:

\begin{verbatim}
<a href="9021384984901238490128490123841222223312.png" download="denoised.png">
  Download the denoised image
</a>
\end{verbatim}

- Look for potential race conditions everywhere in the code, specially at the modules. Use locks to prevent them.

- All webservices should return a \emph{status:KO} when they fail. For example, if they're asked a service which doesn't exist they should return the status:KO, but never simply return a cherrypy message because of an untreated exception. Example of a wrong behavior:

\begin{verbatim}
http://ns3018037.ip-151-80-24.eu:9002/hello

404 Not Found

The path '/hello' was not found.

Traceback (most recent call last):
  File "/usr/lib/python2.7/dist-packages/cherrypy/_cprequest.py", line 670, in respond
    response.body = self.handler()
  File "/usr/lib/python2.7/dist-packages/cherrypy/lib/encoding.py", line 217, in __call__
    self.body = self.oldhandler(*args, **kwargs)
  File "/usr/lib/python2.7/dist-packages/cherrypy/_cperror.py", line 411, in __call__
    raise self
NotFound: (404, "The path '/hello' was not found.")
Powered by CherryPy 3.5.0
\end{verbatim}

- In general, check that no FK reference is missing at any of the database schemas of the modules, and that they're correct.
Also, we need to check absolutely that all the CASCADE DELETE are correct!

- FYI: the package \emph{sqlitebrowser} seems to be a very good tool to browse and develop the SQLite schemas.

- The demoInfo module returns \emph{Content-Type: text/html} instead of application/json:

\begin{verbatim}
curl --head http://ns3018037.ip-151-80-24.eu:9002/read_demo_description?demodescriptionID=359
HTTP/1.1 200 OK
Date: Sun, 21 Feb 2016 19:41:29 GMT
Content-Length: 3545
Content-Type: text/html;charset=utf-8
Server: CherryPy/3.5.0
\end{verbatim}
\ToDo{Check that all modules return application/json and Content-Type: text/json;charset=utf-8}

Also, this module returns a JSON which contains a lots of backslashes!:

\begin{verbatim}
curl "http://ns3018037.ip-151-80-24.eu:9002/read_demo_description?demodescriptionID=359"

{"status": "OK", "demo_description": "\"{\\\"archive\\\": {\\\"files\\\": {\\\"diffInputIHS.png\\\":
\\\"difference input-IHS\\\", \\\"diffInputPanS.png\\\": \\\"difference input-pansharpened\\\",
\\\"ihs.png\\\": \\\"IHS image\\\", \\\"input_0.sel.png\\\": \\\"input image\\\",
\\\"lowspectral.png\\\": \\\"lowspectral image\\\", \\\"pan.png\\\": \\\"pan image\\\",
\\\"pansharpened.png\\\": \\\"pansharpened image\\\"}, \\\"params\\\": [\\\"sfactor\\\"]},
\\\"build\\\": [{\\\"binaries\\\": [[\\\".\\\", \\\"pansharpening_ipol\\\"],
\end{verbatim}

This is clearly wrong. Compare with
\begin{verbatim}
curl "http://api.flickr.com/services/feeds/photos_public.gne?format=json"

sonFlickrFeed({
                "title": "Uploads from everyone",
                "link": "http://www.flickr.com/photos/",
                "description": "",
                "modified": "2016-02-21T19:58:40Z",
                "generator": "http://www.flickr.com/",
                "items": [
           {
                        "title": "P5302235",
                        "link": "http://www.flickr.com/photos/lievensoete/245457
53194/",
...
\end{verbatim}
\ToDo{Correct demoInfo so it returns a correct JSON response}

- A way to get images from the browser in a smartphone with HTML5: \url{http://don.github.io/html-cam/}

\ToDo{Keep adding!}


\section{To Do}
- Automatic testing. Two kind of tests:
\begin{itemize}
  \item For the IPOL system itself
  \item To ensure good compilation of the algorithm source codes
\end{itemize}

We need to use PyUnit for the unit tests.

- Implement authentication in the Proxy to prevent that unauthorized entities (i.e. other that the CP) perform write operations in the system. It can be done for example with a service in the Proxy which add the client to a table of authorized clients for some time, and a list of privileged functions in the API.

- Related for the previous point, configure {\tt iptables} to block access to certain services. It seems that we'll have to put the services in one port and the static content in other, to filter the access. This problem needs to be studied.

- When a error happens during execution, the core should send an email to the autors, and also IPOL's tech and edit.

- Now the flow to execute a demo is as follows: 1) The JQuery calls the run webservices in the Core 2) The Core runs the demo and sends back the results to JQuery in the JSON response. This is the right way to do it and the flow must not change. However, we could use asynchronous push status messages\footnote{\url{https://www.w3.org/TR/push-api/}} from the Core to the client related to the execution (say, when it's compiling, copying blobs, doing conversions or running the user's code). 

- Add statistics data collecting. Piwik can be used for this. Or Google Analytics, amongs others.


\subsection{Design issues (a.k.a. \emph{Hall of Shame})}
\miguel{This section is maintained by Miguel Colom to track bad design issues. Please do never edit it.}


- DemoRunner has a lot of {\tt exec} commands which inject code to update variables in the DR Python's workspace. This solution is totally unacceptable from the point of view of system design and moreover it means a huge security risk for the server. The possibility of manipulating variables in the DDL with the {\tt python: } prefix does not justify such a bad design.

The proposed solution is that DR reads the parameters from the webservice's call, update a dictionary without code injection, and makes very simple substitutions. For example:

\begin{verbatim}
run.sh ${sigma} ${removeFlag} ${demoExtras}/data/polynomial${polNum}.txt
\end{verbatim}

The user's scripts are allowed to write a file with the params and variable values, which will be read by the Core and send it along the run response to the JQuery code. This allows to update parameters and variables in the client interface.

The idea behind the DDL is to \emph{describe} the demo, not to specify the operations needed to run it. Thus, any scripts containing running operations must be given as a user's script will will be called from run.sh

- DemoRunner is writing a {\tt params.json} file and stores it in the run directory. Actually, only the Core needs to write and read this file. It doesn't make any sense that demoRunner stores these parameters. If we consider that we finally need this {\tt params.json} file to re-create the page in another client given the demo ID and experiment key, it should be the Core, not DemoRunner who is responsible for writing and reading it.

In the current system another use of the {\tt params.json} file is to store the lines drawn by the user. It's correct that this data is considered as a parameter, and it's true that perhaps it's too big to be passed as a text string. In any case, if we adopt the solution of keeping the {\tt params.json} file in the run directory, it has to be written by the Core, never by DemoRunner.

- DemoRunner is writing a {\tt results.json} file. Exactly the same bad design issue as in the previous point. That's totally out of the scope of DemoRunner and it should be the Core who eventually would write that file.


\bibliographystyle{plain}
\bibliography{biblio}

\end{document}
% End of document

