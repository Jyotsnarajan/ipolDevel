\section{The Demo Description Language}

current version is 1.0

\subsection{Introduction}
The Demo Description Language (DDL) is a textual description of a IPOL demo that 
allows to compile, generate a web interface, and run a demo. The description is 
written in JSON (JavaScript Object Notation) format, which is a standard format 
used in web applications. Current the JSON files are located in the 'static/JSON'
subdirectory. This language is evolving to allow a maximum number 
of demos to be described without the need to manually write HTML or Python code 
for a given demo. Each main key in the description file is described in the 
following sections:
\begin{itemize}
  \item \textit{general}: some general options;
  \item \textit{build}: everything needed to download and compile the source code;
  \item \textit{inputs}: description of the different inputs;
  \item \textit{params}: description of the parameters, for the param page;
  \item \textit{run}: commands to run the demo;
  \item \textit{config}: configuration, saving demo information;
  \item \textit{archive}: describes what is saved in archive when inputs are uploaded;
  \item \textit{results}: displaying the result page.
\end{itemize}



{\bf Note:} in JSON format, always use double quotes around keys or string 
values, not single quotes. Use can use the following link (or any other validator)
to check if your JSON code is valid: http://jsonlint.com/.
Also be carreful with commas, missing or additional commas are often the cause of
invalid JSON files.

\ToDo{[Miguel]: Why JSON? XML seems more readable. [Karl] I don't agree, for me
XML is more cumbersome, but JSON has the problem of not accepting comments, they 
are different ways to get around it. Jsonnet seems to be a nice option.}

%-------------------------------------------------------------------------------
\subsection{The \emph{general} section}
The general section describes global information about the demo.
It is a set of  (key,value) pairs, described in the following table.
Many keys are derived from the static variables of the previous 'app' Python class.\\
% 
\begin{longtable}{|>{\bf}L{\dimexpr 0.28\linewidth}|L{\dimexpr 
0.57\linewidth}|c|}
\hline
 \centering {key}     & \centering {\bf description} & {\bf req} 
\tabularnewline \hline \hline
 demo\_title         & demo title & yes\\ \hline
 input\_description  & description at the top of the input selection page 
                     & yes \\ \hline
 param\_description  & description at the top of the para\-meters page & yes
                      \\ \hline
 is\_test           & boolean (true/false), if true will be removed from demos 
if the server is in production mode.& yes  \\ \hline
 xlink\_article     & defines the link to the article webpage & yes  \\ \hline
 enable\_crop       & enable or disable cropping for this demo, default is true 
                      (crop enabled). & no   \\ \hline
 crop\_maxsize      & limit allowed crop size in both width and height, the string
                      can contain an Angular expression which will be evaluated & no \\ \hline
 thumbnail\_size    & set initial thumbnail size for the input selection page & no \\ \hline
 input\_condition   & sets a condition on inputs using for example the input sizes & no \\ \hline
 show\_results\_on\-\_error & show results even if the demo returned a run-time error.
                    the demo will be able to display pertinent information & no \\ \hline
\caption{Keys for the 'general' section ({\em req} means required).}
\end{longtable}

%-------------------------------------------------------------------------------
\subsection{The \emph{build} section}

The build section contains an array of build descriptions in the form
''[ \{...\}, \{...\}, ...] ''. For each description, an archive containing the 
source code is downloaded and compiled using either 'make' or 'cmake' features.
It has the following information:

\subsubsection{Common values}

\begin{longtable}{|>{\bf}L{\dimexpr 0.15\linewidth}|L{\dimexpr 0.7\linewidth}|c|}
\hline
\centering {key}     & \centering {\bf description} & {\bf req} \tabularnewline 
\hline \hline
 build\_type & optional, default is 'make', for CMake use 'cmake' (cases are ignored) & no \\ \hline
 url        & full url link to download the demo source code & yes \\ \hline
 srcdir     & subdirectory from the extracted archive where the source code is 
            located & yes \\ \hline
 binaries   & list of binaries and their associated paths relative to the source 
            code path. In case of 'make' build type, the first path is the compilation
            path, where the make command is called, the second path is the binary
            path. You can run make without a binary name by setting the second
            path to a directory, then all files from this directory will be copied
            to the demo binary path.
            & yes \\ \hline
 flags      & make command compilation flags & yes \\ \hline
 scripts    & list of scripts and their associated paths relative to the source 
            code path & no  \\ \hline
\caption{Additional keys for the 'text\_file' type.}
\end{longtable}

\subsubsection{\emph{make} type}

\begin{longtable}{|>{\bf}L{\dimexpr 0.25\linewidth}|L{\dimexpr 0.6\linewidth}|c|}
\hline
\centering {key}     & \centering {\bf description} & {\bf req} \tabularnewline 
\hline \hline
 prepare\_make & shell command used to fix compilation errors of the source code,
                since the source code is steady & no  \\ \hline
\caption{Additional keys for the 'make' type.}
\end{longtable}

\paragraph{Example}:\\
\begin{lstlisting}[language=json,firstnumber=1]
"build": { 
  "url"      : "http://www.ipol.im/xxx/ldm_q1p.zip", 
  "srcdir"   : ".",
  "binaries" : [ [".","lens_distortion_correction"] ],
  "flags"    : "OMP=1 -j4" }
\end{lstlisting}

\subsubsection{\emph{cmake} type}

\begin{longtable}{|>{\bf}L{\dimexpr 0.25\linewidth}|L{\dimexpr 0.6\linewidth}|c|}
\hline
\centering {key}     & \centering {\bf description} & {\bf req} \tabularnewline 
\hline \hline
 prepare\_cmake & shell command used to fix compilation errors of the source code,
                since the source code is steady & no  \\ \hline
 cmake\_flags  & cmake flags for configuration ('Release' build type is 
                automatically set) & no  \\ \hline
\caption{Additional keys for the 'cmake' type.}
\end{longtable}

\paragraph{Example}:\\
\begin{lstlisting}[language=json,firstnumber=1]
"build": { 
  "url"      : "http://www.ipol.im/xxx/ldm_q1p.zip", 
  "srcdir"   : ".",
  "binaries" : [ [".","lens_distortion_correction"] ],
  "flags"    : "OMP=1 -j4" }
\end{lstlisting}

%-------------------------------------------------------------------------------
\subsection{The \emph{inputs} section}
The inputs section describes the set of input data of the algorithm (images, 
videos, flows, etc..).

\begin{longtable}{|>{\bf}L{\dimexpr 0.15\linewidth}|L{\dimexpr 0.7\linewidth}|c|}
\hline
\centering {key}     & \centering {\bf description} & {\bf req} \tabularnewline 
\hline \hline
 type         & current types are ``image'' and ``flow'' & yes \\ \hline
 description  & Short name or description of the input, it will used to display 
the input as the label inside the 'gallery' html display & yes \\ \hline
 max\_pixels   &  sets the maximal number of pixels of the input image, 
bigger images will be downsized, if 0 no resizing is done. The resizing as 
defined in the image class uses python PIL resizing with 'antialias' option. 
Input can be a number or a string that will be evaluated in Angular.  & .. \\ \hline
 max\_weight   & max size (in bytes) of an input file, prevents uploading 
bigger files. Input can be a number or a string that will be evaluated in Angular. & .. \\ \hline
 dtype        & input image expected data type, used as parameter of 
image.convert() method. Possible values are '1x8i' and '3x8i' which are 
converted respectively to 'L' and 'RGB' for PIL. & .. \\ \hline
 ext          & input image expected extention (ie. file format) & .. \\ \hline
\caption{Additional keys for the 'text\_file' type.}
\end{longtable}


%-------------------------------------------------------------------------------
\subsection{The \emph{params} section}
The params section describes the set of parameters needed by a demo, their 
constraints and their visual appearance. It is defined as an array of sets, 
where each set contains (key,value) pairs.

\subsubsection{Common values}

\begin{longtable}{|>{\bf}L{\dimexpr 0.27\linewidth}|L{\dimexpr 
0.58\linewidth}|c|}
\hline
 \centering {key}     & \centering {\bf description} & {\bf req} 
\tabularnewline \hline \hline
 type  & parameter type, one of \{ label, range, selection\_collapsed \}.
                     & yes \\ \hline
 label & description of the parameter or contents if type is label. & yes
                      \\ \hline
\caption{Common keys for the 'params' section ({\em req} means required).}
\end{longtable}


\subsubsection{ \emph{label} type}
The label type does not need any other value. It can be used as a title to 
separate groups of parameters.

\subsubsection{ \emph{selection\_collapsed} type}

The values of the selection are stored as strings, so we map each label with a 
string value. The default value is stored in a separate field.

\begin{longtable}{|>{\bf}L{\dimexpr 0.25\linewidth}|L{\dimexpr 
0.6\linewidth}|c|}
\hline
 \centering {key}     & \centering {\bf description} & {\bf req} 
\tabularnewline \hline \hline
 id     & parameter name in lowercase letters & yes \\ \hline
 values & set of (key,value) pairs, where the key is the displayed text and the 
value a string representing the corresponding value, for example \{ 
``black'':``0'', ``1\%'':``0.01'' \} & yes
                      \\ \hline
 default\_value & defines the default value for this parameter, should be one 
the values defined in 'values'. & yes \\ \hline
\caption{Additional keys for the 'selection\_collapsed' type.}
\end{longtable}

\subsubsection{ \emph{range} type}

The values of the range type are stored as numbers, so no double quotes are 
required around the values. The default value is stored with the 'values' field.

\begin{longtable}{|>{\bf}L{\dimexpr 0.15\linewidth}|L{\dimexpr 
0.7\linewidth}|c|}
\hline
 \centering {key}     & \centering {\bf description} & {\bf req} 
\tabularnewline \hline \hline
 id     & parameter name in lowercase letters  & yes \\ \hline
 values & set min,max,step and default values using the following key/value 
scheme \{ ``min'':val, ``max'':val, ``step'':val, ``default'':val \} & yes
                      \\ \hline
\caption{Additional keys for the 'range' type.}
\end{longtable}

%-------------------------------------------------------------------------------
\subsection{The \emph{run} section}

In the command line, you can use \$param\_id to replace the to evaluate a 
python expression that can contain the parameter ids,
and '\textgreater output\_file' (without space between '\textgreater' and the 
filename) to redirect the standard output to a given file, save in the current 
working directory. 
If you also want to redirect the standard errors to the same file, use can add 
'2\textgreater\&1' as another argument. However, pipelines are not allowed 
('|' character).
Python scripts from the PythonTools directory can be used in commands.

\paragraph{Example}:\\
\begin{lstlisting}[language=json,firstnumber=1]
"run": [
  "nlmeans  input_0.sel.png $sigma input_1.png output_1.png",
  "img_diff input_0.sel.png input_1.png $sigma output_2.png",
  "img_mse  input_0.sel.png output_1.png >stdout.txt 2>&1"
]
\end{lstlisting}

%-------------------------------------------------------------------------------
\subsection{The \emph{config} section}

The config section is optional, it allows creating new (key,value) pairs in the 
configuration file based on text files obtained during the execution. This 
new information can then be used in the archive section.

\begin{longtable}{|>{\bf}L{\dimexpr 0.25\linewidth}|L{\dimexpr 0.6\linewidth}|c|}
\hline
\centering {key}     & \centering {\bf description} & {\bf req} \tabularnewline 
\hline \hline
 info\_from\_file    & it contains a list of (key,value) pairs where the key is
            the new information id to create (in lowercase letters) and the
            value is the corresponding text file that contains its contents & no \\ \hline
\caption{keys for the 'config' section.}
\end{longtable}

\paragraph{Example}:\\
\begin{lstlisting}[language=json,firstnumber=1]
"config":
  {
    "info_from_file": {  "homography_1" : "output_0.txt",
                          "homography_2" : "output_1.txt"
                      }
  }
\end{lstlisting}

%-------------------------------------------------------------------------------
\subsection{The \emph{archive} section}

\begin{longtable}{|>{\bf}L{\dimexpr 0.25\linewidth}|L{\dimexpr 0.6\linewidth}|c|}
\hline
\centering {key}     & \centering {\bf description} & {\bf req} \tabularnewline 
\hline \hline
 files    &  & no \\ \hline
 compres\-sed\_\-files   &  & no \\ \hline
 params &  & no \\ \hline
 info    & & no \\ \hline
\caption{Additional keys for the 'text\_file' type.}
\end{longtable}


\paragraph{Example}:\\
\begin{lstlisting}[language=json,firstnumber=1]
"archive":
  {
    "files" : 
      { "input_0.png"                 : "input image",
        "primitives.txt"              : "Primitives"  },
    "params" :  
      [ "high_threshold_canny", 
        "initial_distortion_parameter", 
        "angle_point_orientation_max_difference" ],
    "info"   : { "run_time": "run time" }
  }
\end{lstlisting}

%-------------------------------------------------------------------------------
\subsection{The \emph{results} section}


The results section also contains an array of sets, where each each contains 
(key/value) pairs describing one type of output from the algorithm. There are 
displayed sequentially one below the other, a part from warnings that are 
displayed at the top of the page. The currently available types are described 
below. At the top of the results page, the processing time is displayed and the 
user is proposed to run the demo again with different input or parameters.

\begin{longtable}{|>{\bf}L{\dimexpr 0.15\linewidth}|L{\dimexpr 
0.7\linewidth}|c|}
\hline
 \centering {key}     & \centering {\bf description} & {\bf req} 
\tabularnewline \hline \hline
 type      & type is one of \{  warning, gallery, repeat\_gallery, html\_text, 
                                file\_download, text\_file \}  & yes \\ \hline
\caption{Common keys for the 'results' section.}
\end{longtable}


%------ warning  ------
\subsubsection{ \emph{warning} type}

\begin{longtable}{|>{\bf}L{\dimexpr 0.15\linewidth}|L{\dimexpr 
0.7\linewidth}|c|}
\hline
 \centering {key}     & \centering {\bf description} & {\bf req} 
\tabularnewline \hline \hline
 condition & warning condition evaluated by AngularJS in its 
the context of the result controler named {\em DemoResultCtrl}. In this 
context, the user has access, among other variables, to: -'demo' which 
contains the demo description, - 'params' which contains the current 
values of all the parameters, - sizeX and sizeY as the input image dimensions.  
& yes \\ \hline
 contents  & displayed text, can contain both HTML tags and AngularJS 
expressions of the form '\{\{expression\}\}'. & \\ \hline
\caption{Additional keys for the 'warning' type.}
\end{longtable}

\paragraph{Example}:\\

\begin{lstlisting}[language=json,firstnumber=1]
{ "type":"warning", 
  "condition":"sizeX * sizeY < X",
  "contents":"Needs X pixels ({{sizeX *sizeY}} given)<br/>"},
\end{lstlisting}

%------ gallery  ------
\subsubsection{ \emph{gallery} type}

The gallery type uses the gallery class to display images. Its parameters are:

\begin{longtable}{|>{\bf}L{\dimexpr 0.15\linewidth}|L{\dimexpr 0.7\linewidth}|c|}
\hline
 \centering {key}     & \centering {\bf description} & {\bf req} 
\tabularnewline \hline \hline
 label      & & yes \\ \hline
 contents   & & yes \\ \hline
 style      & & yes \\ \hline
\caption{Additional keys for the 'gallery' type.}
\end{longtable}

\paragraph{Example}:\\
\begin{lstlisting}[language=json,firstnumber=1]
{ "type"     : "gallery",
  "label"    : "<h3>Images</h3>",
  "contents" : {"Input":"input.png", "Output":"output.png"},
  "style"    : "width:{{sizeY}}px" },
\end{lstlisting}

%------ repeat_gallery  ------
\subsubsection{ \emph{repeat\_gallery} type}
The repeat\_gallery type is design to display a gallery with a number of images 
that depend on a parameter, for example the number of scales used by the 
algorithm.

\begin{longtable}{|>{\bf}L{\dimexpr 0.15\linewidth}|L{\dimexpr 0.7\linewidth}|c|}
\hline
\centering {key}     & \centering {\bf description} & {\bf req} \tabularnewline 
\hline \hline
 label      & & yes \\ \hline
 repeat     & & yes \\ \hline
 contents   & & yes \\ \hline
 style      & & yes \\ \hline
\caption{Additional keys for the 'repeat\_gallery' type.}
\end{longtable}

\paragraph{Example}:\\
\begin{lstlisting}[language=json,firstnumber=1]
{ "type"     : "repeat_gallery",
  "repeat"   : "params.scales",
  "label"    : "<h2> Noise Curves </h2>",
  "contents" : [ "Scale {{idx}}: curve_{{idx}}.png"],
  "style"    : "height:600px" },
\end{lstlisting}

%------ html_text  ------
\subsubsection{ \emph{html\_text} type}

\begin{longtable}{|>{\bf}L{\dimexpr 0.15\linewidth}|L{\dimexpr 0.7\linewidth}|c|}
\hline
\centering {key}     & \centering {\bf description} & {\bf req} \tabularnewline 
\hline \hline
 contents   & & yes \\ \hline
\caption{Additional keys for the 'html\_text' type.}
\end{longtable}

\paragraph{Example}:\\
\begin{lstlisting}[language=json,firstnumber=1]
{ "type"     : "html_text", 
  "contents" : "Noise variance = {{params.anoise}}<br/>..."},
\end{lstlisting}

\subsubsection{ \emph{file\_download} type}

\begin{longtable}{|>{\bf}L{\dimexpr 0.15\linewidth}|L{\dimexpr 0.7\linewidth}|c|}
\hline
\centering {key}     & \centering {\bf description} & {\bf req} \tabularnewline 
\hline \hline
 label      & & yes \\ \hline
 contents   & & yes \\ \hline
\caption{Additional keys for the 'file\_download' type.}
\end{longtable}

\paragraph{Example}:\\
\begin{lstlisting}[language=json,firstnumber=1]
   {  "type"     : "file_download", 
      "label"    : "Download Hough result",
      "contents" : "output_hough.png" },
\end{lstlisting}

\subsubsection{ \emph{text\_file} type}

\begin{longtable}{|>{\bf}L{\dimexpr 0.15\linewidth}|L{\dimexpr 0.7\linewidth}|c|}
\hline
\centering {key}     & \centering {\bf description} & {\bf req} \tabularnewline 
\hline \hline
 label      & & yes \\ \hline
 contents   & & yes \\ \hline
 style      & & yes \\ \hline
\caption{Additional keys for the 'text\_file' type.}
\end{longtable}

\paragraph{Example}:\\
\begin{lstlisting}[language=json,firstnumber=1]
{  "type"     : "text_file", 
  "label"    : "<h2>Additional info<h2>",
  "contents" : "output.txt",
  "style"    : "width:{{sizeX}}px;height:14em" },
\end{lstlisting}

%-------------------------------------------------------------------------------
\subsection{Full examples}


\subsubsection{keywords}

\section{AngularJS components}
\subsection{Services}
\subsection{Controlers}
\subsection{Templates}
