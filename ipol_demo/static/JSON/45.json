{ 
  "general": { 
    "demo_title"            :  "Analysis and Extension of the Ponomarenko et al Method, Estimating a Noise Curve from a Single Image",
    "input_description"     : "This algorithm estimates the amount of noise (standard deviation) of the given image.<br/><br/>The test images are divided into three groups:<br/><br/><ul><li>Raw images down-scaled to have one raw value (R, G, B) at each pixel. Their raw values are multiplied by 32 in order to be able to visualize them. In the list, they are are refered to as <b>raw</b>.</li><li>High SNR raw images, downscaled by 8 and the color channels averaged, so they are nearly noiseless. In the list, they are refered to as <b>no noise</b>.</li><li>JPEG images, being denoised by JPEG at the first scales. In the list, they are refered to as <b>JPEG</b>.</li> </ul>",
    "param_description"     : "Ponomarenko signal-dependent noise estimation algorithm.",
    "input_nb"              : 1,
    "input_max_pixels"      : 25000000,
    "input_max_weight"      : 10000000,
    "input_dtype"           : "3x8i",
    "input_ext"             : ".png",
    "is_test"               : false,
    "xlink_article"         : "http://www.ipol.im/pub/art/2013/45/"
  }, 
  "params": [
    {
      "id"            : "percentile",
      "type"          : "selection_collapsed", 
      "label"         : "Percentile",
      "values"        : {"Auto (algorithm's K)":"-999.999", "0.01%":"0.0001", "0.1%":"0.001", "0.5%":"0.005", "5%":"0.05", "10%":"0.1", "50%":"0.5"},
      "type_format"   : "float",
      "default_value" : "0.005",
      "value"         : "0.005"
    },
    {
      "id"            : "block",
      "type"          : "selection_collapsed", 
      "label"         : "Block",
      "values"        : {"3 x 3":"3", "5 x 5":"5", "7 x 7":"7", "8 x 8":"8", "11 x 11":"11", "15 x 15":"15", "21 x 21":"21"},
      "type_format"   : "float",
      "default_value" : "8",
      "value"         : "8"
    },
    {
      "id"            : "mean_type",
      "type"          : "selection_collapsed", 
      "label"         : "Mean of blocks computation",
      "values"        : {"Mean":"1", "Median":"2"},
      "type_format"   : "float",
      "default_value" : "2",
      "value"         : "2"
    },    
    {
      "id"            : "curvefilter",
      "type"          : "selection_collapsed", 
      "label"         : "Curve filter iterations:",
      "values"        : {"None":"0", "1 iteration":"1", "2 iterations":"2", "3 iterations":"3", "4 iterations":"4", "5 iterations":"5", "6 iterations":"6", "7 iterations":"7"},    
      "type_format"   : "float",
      "default_value" : "5",
      "value"         : "5"
    },        
    {
      "id"            : "removeequals",
      "type"          : "selection_collapsed", 
      "label"         : "Treatment of groups (2x2) of equal pixels",
      "values"        : {"Use all the pixels in the image":"0", "Ignore that kind of pixels":"1"},
      "type_format"   : "float",
      "default_value" : "1",
      "value"         : "1"
    },        
    {
      "id"            : "bins",
      "type"          : "range", 
      "label"         : "Number of bins (0 = automatic selection)",
      "values"        : { "min":"0", "max":"150", "step":"1"},
      "type_format"   : "string",
      "default_value" : "0",
      "value"         : 0
    },            
    {
      "id"            : "noise_variance",
      "type"          : "label", 
      "label"         : " <label> Noise variance (<i>A</i>+<i>B</i><b>u</b>, where <b>u</b> is the input noisy image. Set <i>B</i>=0 for uniform noise) </label>",
      "default_value" : "A",
      "type_format"   : "string"
    },
    {
      "id"            : "anoise",
      "type"          : "range", 
      "label"         : "A",
      "values"        : { "min":"0.0", "max":"10000.0", "step":"0.1"},
      "type_format"   : "string",
      "default_value" : "0",
      "value"         : 0
    },
    {
      "id"            : "bnoise",
      "type"          : "range", 
      "label"         : "B",
      "values"        : { "min":"0.0", "max":"39.0", "step":"0.1"},
      "type_format"   : "string",
      "default_value" : "0",
      "value"         : 0
    }
  ],
  "results": [
    {
      "type"          : "run_again", 
      "contents"      : "Run"
    },
    {
      "type"          : "warning", 
      "condition"     : "sizeX * sizeY < 42000",
      "contents"      : "Image too small: the input image needs to be at least 42000 pixels to get a reliable estimate<br/> Forced to use one bin for the estimation."
    },
    {
      "type"          : "warning", 
      "condition"     : "sizeX * sizeY < 20000",
      "contents"      : "Image too small: at least 20000 pixels are need to be able to estimate the noise. No estimation is given with {{sizeX * sizeY}} pixels<br/>"
    },
    {
      "type"          : "image",
      "label"         : "Input image:",
      "contents"      : "scale_s0.png",
      "style"         : "width:600px" 
    },
    {
      "type"          : "html_text", 
      "contents"      : "Additional noise of variance = {{params.anoise}} + {{params.bnoise}}u.<br/>\nNote that here the image may be showed with a size different from the original to help looking at the results.<br/>"
    },
    {
      "type"          : "repeat_image",
      "repeat"        : "params.scales",
      "label"         : "'* Noise curve for scale S'+idx+':'",
      "contents"      : "'curve_s'+idx+'.png'",
      "style"         : "" 
    },
    {
      "repeat"        : "params.scales",
      "type"          : "file_download", 
      "label"         : "Download the estimations obtained at scale {{idx}} (gnuplot compatible format)",
      "contents"      : "'estimation_s'+idx+'.txt'"
    }
  ],
  "build":
    {
      "url"       : "http://www.ipol.im/pub/art/2013/45/ponomarenko_v4.zip", 
      "srcdir"    : "ponomarenko_v4",
      "binaries"  : [ ["ponomarenko","ponomarenko"] , ["fnoise","fnoise"], ["subscale","subscale"] ],
      "flags"     : "-j4",
      "scripts"   : [ ["scripts","writeNoiseCurve.sh"] ]
    }
  ,
  "archive":
    {
      "files" : { "input_0.orig.png": "uploaded image",
                  "input_0.sel.png" : "selected subimage"
                },
      "params" :  [ "percentile", "block", "curvefilter", "removeequals", "bins", "anoise", "bnoise", "mean_type"]
    }
  ,
  "run": [
     "fnoise -A $anoise -B $bnoise input_0.sel.png scale_s0.rgb",
     "fnoise -A $anoise -B $bnoise -t input_0.sel.png scale_s0.png",
     "run_algo.py"
  ]

}