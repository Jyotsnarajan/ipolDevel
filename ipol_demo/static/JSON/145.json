{ 
  "general": { 
    "demo_title"            :  "A Demosaicking Algorithm with Adaptive Inter-Channel Correlation",
    "input_description"     : "Please select or upload the image pair to register.",
    "param_description"     : "",
    "xlink_article"         : "http://www.ipol.im/pub/art/2015/145/"
  }, 
  "build": [
    {
      "build_type"    : "make",
      "url"           : "http://www.ipol.im/pub/art/2015/145/DB_demosaicking_code.tar.gz", 
      "srcdir"        : "DB_demosaicking_code",
      "__prepare_make__"  : "sed -i -e 's/CXXFLAGS  =/CXXFLAGS  = -include cstring /g' Makefile; mkdir obj; mkdir bin",
      "binaries"      : [ [".","demosaicking_ipol"], [".","imdiff_ipol"] ],
      "flags"         : "OMP=1 -j4"
    } ]
  ,
  "inputs": [  
      {
          "type"            : "image", 
          "description"     : "first image",
          "max_pixels"      : "700 * 700",
          "max_weight"      : "10 * 1024 * 1024",
          "dtype"           : "3x8i",
          "ext"             : ".png"
      }
    ],
  "params": [
    {
        "id"            : "guessbeta",
        "type"          : "checkbox",
        "label"         : "Compute &beta; dynamically",
        "default_value" : true
    },
    {
        "visible"       : "!demo.params[0].value",
        "id"            : "beta",
        "type"          : "range", 
        "label"         : "&beta;",
        "comments"      : [ "Optimal value for Kodak dataset: &beta;=1.0 <br/>",
                            "Optimal value for McMaster (IMAX) images: &beta;=0.7" ],
        "values"        : { "min":0.7, "max":1.0, "step":0.01, "default":0.7 }
    }
  ],
  "run": [ 
    ["guessbeta",
        "# need to create the 'beta' parameter as if it was already present",
        "python:self.algo_params['beta']=0",
        "# the local variable is the one to modify, it will then be copied to algo_params...",
        "python:beta=0"
    ],
    "demosaicking_ipol input_0.sel.png mosaicked.png demosaicked.png $beta >beta.txt 2>stdout.txt",
    "imdiff_ipol input_0.sel.png demosaicked.png diff.png >rmse.txt 2>stdout.txt",
    "# Read the rmse.txt file",
    "python:f = open(self.work_dir + 'rmse.txt', 'r')",
    "python:self.algo_info['rmse']='%.2f' % float(f.readline().split(':', 1)[1])",
    "python:f.close()",
    ["guessbeta",
        "# Read beta value",
        "python:f = open(self.work_dir + 'beta.txt', 'r')",
        "python:l=f.readline()",
        "python:beta = '%.2f' % float(l.split(':', 1)[1])",
        "python:f.close()"],
    "# Resize for visualization (always zoom by at least 2x)",
    "python:(sizeX, sizeY) = image(self.work_dir + 'input_0.sel.png').size",
    "python:zoomfactor = max(1, int(math.ceil(480.0/max(sizeX, sizeY))))",
    ["zoomfactor>1",
        "python:(sizeX, sizeY) = (zoomfactor*sizeX, zoomfactor*sizeY)",
        "convert -filter point -resize ${sizeX}x${sizeY} input_0.sel.png    input_0.sel_zoom.png",
        "convert -filter point -resize ${sizeX}x${sizeY} mosaicked.png      mosaicked_zoom.png",
        "convert -filter point -resize ${sizeX}x${sizeY} demosaicked.png    demosaicked_zoom.png",
        "convert -filter point -resize ${sizeX}x${sizeY} diff.png           diff_zoom.png" ],
    "python:self.algo_info['zoomfactor']    = zoomfactor",
    "python:self.algo_info['displayheight'] = max(200, sizeY)"
   ],
  "archive":
    {
      "files" : { 
                  "input_0.sel.png"   : "original image",
                  "input_1.orig.png"  : "uploaded #2",
                  "mosaicked.png"     : "mosaicked image",
                  "demosaicked.png"   : "demosaicked image",
                  "diff.png"          : "difference original-demosaicked"
                },
      "params": [ "beta" ],
      "info"  : { "rmse" : "RMSE" }
    }
  ,
  "results": [
    {
        "visible"   : "info.zoomfactor>1",
        "type"      : "file_download",
        "label"     : "<p>For visualization, the images are displayed with {{info.zoomfactor}}&times; pixel duplication. Images at native resolution can be downloaded here:</p>",
        "contents"  : {
                "input"             : "input_0.sel.png",
                "demosaicked"       : "demosaicked.png"
            }
    },
    {
      "type"          : "gallery",
      "label"         : "<p> Images obtained with parameter &beta; = {{params.beta}} <span ng-if='params.guessbeta'> computed dynamically </span><p>",
      "contents"      : 
        {   
        "info.zoomfactor<=1?Input"         : "input_0.sel.png", 
        "info.zoomfactor>1?Input"          : "input_0.sel_zoom.png", 
        "info.zoomfactor<=1?Demosaicked"   : "demosaicked.png", 
        "info.zoomfactor>1?Demosaicked"    : "demosaicked_zoom.png", 
        "info.zoomfactor<=1?Mosaicked"     : "mosaicked.png", 
        "info.zoomfactor>1?Mosaicked"      : "mosaicked_zoom.png", 
        "info.zoomfactor<=1?Difference Input-Demosaicked <br/> RMSE {{info.rmse}}" : "diff.png",
        "info.zoomfactor>1?Difference Input-Demosaicked <br/> RMSE {{info.rmse}}"  : "diff_zoom.png"
        },
      "style"         : "{'height':info.displayheight*ZoomFactor+'px'}" 
    }
  ]

}